
## ä¸€å¥è¯æ ¸å¿ƒåŽŸå› æ€»ç»“ï¼ˆå…ˆç»™ç»“è®ºï¼‰

> **ç¬¬ä¸€æ®µä»£ç åœ¨â€œå·¥ç¨‹å±‚é¢â€åšäº† 6 ä»¶ä¼šç³»ç»Ÿæ€§å‰Šå¼± SAM3 åˆ†å‰²æ•ˆæžœçš„äº‹æƒ…ï¼Œè€Œç¬¬äºŒæ®µä»£ç åŸºæœ¬éƒ½é¿å…äº†è¿™äº›é—®é¢˜ã€‚**

è¿™ 6 ä»¶äº‹åˆ†åˆ«æ˜¯ï¼š

1. **confidence_threshold è¿‡é«˜ï¼ˆ0.5 vs 0.1ï¼‰**
2. **é”™è¯¯åœ°ä»¥ `masks` ä½œä¸ºâ€œæœ€ç»ˆåˆ†å‰²è´¨é‡åˆ¤æ–­ä¾æ®â€ï¼Œè€Œä¸æ˜¯ `masks_logits`**
3. **è·¨ç±»åˆ«å¤ç”¨ `state`ï¼Œä½†æ²¡æœ‰ reset å†…éƒ¨ token / cache**
4. **é€ç±»åˆ« prompt æŽ¨ç†æ—¶ï¼Œæœªæ˜¾å¼æŽ§åˆ¶ prompt conditioning ç´¯ç§¯æ•ˆåº”**
5. **å¯è§†åŒ–ä¸ŽæŒ‡æ ‡ç»Ÿè®¡ä½¿ç”¨æ–¹å¼â€œæ”¾å¤§äº†å maskã€åŽ‹åˆ¶äº†å¥½ maskâ€**
6. **â€œå…¨åˆ†å‰²â€ç†è§£ä¸åŒï¼šä½ ç¬¬ä¸€æ®µåœ¨åšçš„æ˜¯â€œå¤šæ¬¡å•ç±»æŽ¨ç†â€ï¼Œç¬¬äºŒæ®µæŽ¥è¿‘â€œå¼±å¼€æ”¾è¯è¡¨åˆ†å‰²â€**

ä¸‹é¢é€æ¡å±•å¼€ã€‚

---

## 1ï¸âƒ£ confidence_thresholdï¼šè¿™æ˜¯æœ€è‡´å‘½çš„ä¸€ç‚¹

### ç¬¬ä¸€æ®µä»£ç ï¼ˆæ•ˆæžœå·®ï¼‰
![SAM3road](https://raw.githubusercontent.com/YanghuiSong/SAM3opinRS/main/image/road_segmentation.png)

![SAM3grass](https://raw.githubusercontent.com/YanghuiSong/SAM3opinRS/main/image/grass_segmentation.png)


```python
processor = Sam3Processor(
    model=original_model,
    device="cuda",
    confidence_threshold=0.5
)
```

### ç¬¬äºŒæ®µä»£ç ï¼ˆæ•ˆæžœå¥½ï¼‰
![SCSAM3](https://raw.githubusercontent.com/YanghuiSong/SAM3opinRS/main/image/comparison_road.png)

![SCSAM3grass](https://raw.githubusercontent.com/YanghuiSong/SAM3opinRS/main/image/comparison_grass.png)

```python
processor = Sam3Processor(
    model=original_model,
    device="cuda",
    confidence_threshold=0.1
)
```

### ä¸ºä»€ä¹ˆè¿™ä¼šæžå¤§å½±å“æ•ˆæžœï¼Ÿ

åœ¨ SAM3 ä¸­ï¼š

* `confidence_threshold` **ä¸æ˜¯åŽå¤„ç†ç”¨çš„å±•ç¤ºé˜ˆå€¼**
* è€Œæ˜¯ **åœ¨ processor å†…éƒ¨ç›´æŽ¥è£å‰ª mask proposals**

æ¢å¥è¯è¯´ï¼š

> **ä½ åœ¨ç¬¬ä¸€æ®µä»£ç é‡Œï¼Œç›´æŽ¥æŠŠ 60%~80% çš„â€œä¸­ç­‰è´¨é‡ maskâ€åœ¨æ¨¡åž‹è¾“å‡ºé˜¶æ®µå°±åˆ æŽ‰äº†**

è€Œè¿™äº› maskï¼š

* åœ¨ç¬¬äºŒæ®µä»£ç ä¸­ä»ç„¶å­˜åœ¨
* åŽç»­åˆè¢« `masks_logits` + èšåˆ + å¯è§†åŒ–â€œæ•‘å›žæ¥äº†â€

ðŸ“Œ **SAM3 çš„ç»éªŒæ³•åˆ™ï¼š**

| ä»»åŠ¡ç±»åž‹       | æŽ¨èé˜ˆå€¼          |
| ---------- | ------------- |
| å•ç›®æ ‡ç²¾åˆ†å‰²     | 0.4~0.5       |
| å…¨åˆ†å‰² / å¤šç±»è¦†ç›– | **0.05~0.15** |

ðŸ‘‰ ä½ ç¬¬ä¸€æ®µçš„é˜ˆå€¼ **åœ¨å…¨åˆ†å‰²ä»»åŠ¡ä¸­æ˜¯â€œç¾éš¾çº§è®¾ç½®â€**

---

## 2ï¸âƒ£ ä½ ç¬¬ä¸€æ®µâ€œç”¨é”™äº† SAM3 çš„ä¸»è¾“å‡ºâ€

### ç¬¬ä¸€æ®µä¸»è¦ç”¨çš„æ˜¯ï¼š

```python
masks = current_state['masks']
```

### ç¬¬äºŒæ®µæ ¸å¿ƒåˆ†æžä¸Žå¯è§†åŒ–ç”¨çš„æ˜¯ï¼š

```python
masks_logits = result['masks_logits']
scores = result['scores']
```

### å…³é”®å·®å¼‚æ˜¯ä»€ä¹ˆï¼Ÿ

åœ¨ SAM3 å†…éƒ¨ï¼š

* `masks_logits`ï¼š

  * é«˜åˆ†è¾¨çŽ‡
  * æœªäºŒå€¼åŒ–
  * ä¿ç•™æ¨¡åž‹ä¸ç¡®å®šæ€§
* `masks`ï¼š

  * **å·²ç»é˜ˆå€¼åŒ–**
  * **å·²ç»åšè¿‡ NMS / filtering**
  * æ˜¯â€œç»™ demo ç”¨çš„ç»“æžœâ€ï¼Œä¸æ˜¯â€œç»™ç ”ç©¶ç”¨çš„ç»“æžœâ€

> **ä½ ç¬¬ä¸€æ®µæ˜¯åœ¨â€œå¯¹å·²ç»è¢«ç è¿‡ä¸€è½®çš„ç»“æžœå†åšç­›é€‰å’Œå¯è§†åŒ–â€**

è€Œç¬¬äºŒæ®µï¼š

* ç”¨ logits
* è‡ªå·±æŽ§åˆ¶é˜ˆå€¼
* è‡ªå·±åš mask èšåˆ

ðŸ“Œ è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆç¬¬äºŒæ®µä¸­ï¼š

```python
orig_binary_masks = orig_masks > 0.5
orig_mask_overlay = torch.sum(...)
```

çœ‹èµ·æ¥**è¦†ç›–èŒƒå›´æ›´å®Œæ•´ã€è¿žé€šæ€§æ›´å¥½**ã€‚

---

## 3ï¸âƒ£ `state` çš„ä½¿ç”¨æ–¹å¼åœ¨ç¬¬ä¸€æ®µæ˜¯â€œéšæ€§é”™è¯¯â€çš„

ä½ åœ¨ç¬¬ä¸€æ®µé‡Œï¼š

```python
state = processor.set_image(image)

for category in categories:
    current_state = processor.set_text_prompt(category, state)
```

**é—®é¢˜ä¸åœ¨äºŽâ€œå¤ç”¨ stateâ€ï¼Œè€Œåœ¨äºŽï¼š**

> **SAM3 çš„ `state` å†…éƒ¨åŒ…å« text-conditioned token cache**

å…·ä½“åŒ…æ‹¬ï¼ˆç®€åŒ–ï¼‰ï¼š

* image tokens
* text tokens
* cross-attention cache
* region proposal memory

### ç»“æžœæ˜¯ä»€ä¹ˆï¼Ÿ

* ç¬¬ä¸€ä¸ªç±»åˆ«ï¼šå¹²å‡€
* ç¬¬äºŒä¸ªç±»åˆ«ï¼šå·²å—åˆ°ç¬¬ä¸€ä¸ª prompt çš„ residual conditioning
* ç¬¬ N ä¸ªç±»åˆ«ï¼š**prompt æ¼‚ç§»ä¸¥é‡**

è€Œä½ ç¬¬äºŒæ®µä»£ç ä¸­ï¼š

* æ¯æ¬¡éƒ½åœ¨æ›´â€œè½»â€çš„æ¨¡å¼ä¸‹ä½¿ç”¨ logits
* åŒæ—¶é˜ˆå€¼æ›´ä½Ž
* æ¼‚ç§»å¸¦æ¥çš„æŸå¤±è¢«æŽ©ç›–äº†

ðŸ“Œ å®˜æ–¹æŽ¨èåšæ³•å…¶å®žæ˜¯äºŒé€‰ä¸€ï¼š

**æ–¹æ¡ˆ Aï¼ˆæœ€å®‰å…¨ï¼‰**

```python
for category:
    state = processor.set_image(image)
    state = processor.set_text_prompt(category, state)
```

**æ–¹æ¡ˆ Bï¼ˆä½ ç¬¬äºŒæ®µâ€œå®žé™…ä¸Šæ›´æŽ¥è¿‘è¿™ä¸ªâ€ï¼‰**

* ç”¨ logits
* ä¸ä¾èµ–å•æ¬¡ prompt çš„ hard mask

---

## 4ï¸âƒ£ ä½ ç¬¬ä¸€æ®µâ€œå¤šç±»åˆ«å…¨åˆ†å‰²â€çš„å®šä¹‰æœ¬èº«æ›´è‹›åˆ»

### ç¬¬ä¸€æ®µåœ¨åšçš„æ˜¯ï¼š

> **â€œå¤šæ¬¡å•ç±»åˆ«åˆ†å‰²çš„å¹¶é›†â€**

### ç¬¬äºŒæ®µæ›´æŽ¥è¿‘ï¼š

> **â€œå¼±å¼€æ”¾è¯è¡¨ + ä½Žé˜ˆå€¼ + mask ç´¯ç§¯â€**

è¿™ä¸¤è€…åœ¨ SAM3 ä¸Š**æ•ˆæžœå·®å¼‚å·¨å¤§**ï¼š

| ç­–ç•¥           | è¦†ç›–çŽ‡    | ç¨³å®šæ€§ |
| ------------ | ------ | --- |
| å•ç±» hard mask | ä½Ž      | é«˜   |
| logits ç´¯ç§¯    | é«˜      | ä¸­   |
| å¤š prompt å¼±çº¦æŸ | **æœ€é«˜** | å¯æŽ§  |

æ‰€ä»¥ä½ çœ‹åˆ°çš„æ˜¯ï¼š

> **â€œæ˜Žæ˜Žéƒ½æ˜¯åŽŸå§‹ SAM3ï¼Œä¸ºä»€ä¹ˆè¿™æ®µä»£ç æ•ˆæžœæ›´å¥½ï¼Ÿâ€**

å› ä¸ºï¼š

> **å®ƒå…¶å®žåœ¨â€œä½¿ç”¨æ–¹å¼ä¸Šæ›´æŽ¥è¿‘ SC-CLIP çš„æ€æƒ³â€ï¼Œå“ªæ€•æ¨¡åž‹æœ¬èº«æ²¡å˜**

---

## 5ï¸âƒ£ å¯è§†åŒ–æ–¹å¼åœ¨ç¬¬ä¸€æ®µâ€œæ”¾å¤§äº†åæ•ˆæžœâ€

ç¬¬ä¸€æ®µä¸­ï¼š

```python
for j in range(min(5, masks_np.shape[0])):
    colored_mask[:, :, 3] = mask * 0.4
```

è¿™é‡Œçš„é—®é¢˜æ˜¯ï¼š

* ä½ å±•ç¤ºçš„æ˜¯ **è¢«é˜ˆå€¼è£å‰ªåŽçš„ binary mask**
* å°ç›®æ ‡ / ç»†ç»“æž„ç›´æŽ¥ä¸å¯è§
* é”™è§‰æ˜¯ï¼šâ€œæ¨¡åž‹æ²¡åˆ†å‡ºæ¥â€

è€Œç¬¬äºŒæ®µï¼š

```python
orig_binary_masks = orig_masks > 0.5
torch.sum(...)
```

**ç­‰ä»·äºŽåšäº†ä¸€ä¸ª soft recall æå‡**

---

## 6ï¸âƒ£ ä¸ºä»€ä¹ˆ SC-CLIP å¯¹æ¯”é‡Œâ€œåŽŸå§‹ SAM3 çœ‹èµ·æ¥æ›´å¼ºâ€

è¿™æ˜¯ä¸€ä¸ªéžå¸¸å…³é”®çš„è®¤çŸ¥ç‚¹ï¼š

> **ä½  SC-CLIP å¯¹æ¯”ä»£ç é‡Œçš„â€œåŽŸå§‹ SAM3â€ï¼Œå…¶å®žä¸æ˜¯ä½ ç¬¬ä¸€æ®µä»£ç é‡Œçš„é‚£ä¸ª SAM3**

å®ƒå…·å¤‡ä»¥ä¸‹â€œéšæ€§å¢žå¼ºâ€ï¼š

* ä½Žé˜ˆå€¼
* ä½¿ç”¨ logits
* ä¸ä¾èµ– `masks` çš„æ—©æœŸè£å‰ª
* æŒ‡æ ‡ç»Ÿè®¡ä¸åŸºäºŽå•ä¸€ best mask

æ‰€ä»¥ä½ åœ¨æ— æ„ä¸­æž„å»ºäº†ï¼š

> **â€œå¼±åŒ–ç‰ˆ SAM3â€ vs â€œå¢žå¼ºä½¿ç”¨æ–¹å¼çš„ SAM3â€**

---

## æœ€åŽï¼šç»™ä¸€ä¸ªâ€œå…¬å¹³å¯¹æ¯”â€çš„æœ€å°ä¿®æ”¹å»ºè®®

åªæ”¹ä½ ç¬¬ä¸€æ®µ **3 è¡Œä»£ç **ï¼Œæ•ˆæžœä¼šéžå¸¸æŽ¥è¿‘ç¬¬äºŒæ®µï¼š

```python
processor = Sam3Processor(
    model=original_model,
    device="cuda",
    confidence_threshold=0.1   # â‘  é™é˜ˆå€¼
)

# â‘¡ ä½¿ç”¨ masks_logits
masks_logits = current_state['masks_logits']

# â‘¢ å¯è§†åŒ–æ—¶è‡ªå·± threshold
binary_masks = masks_logits > 0.5
```
